<style>
    #leaderboard-banner {
        margin-bottom: 20px;
        text-align: center;
        max-width: 100%;
    }

    #leaderboard-banner img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }

    #leaderboard-container {
        font-size: 0.9rem;
        line-height: 1.15;
    }

    #leaderboard-container .gridjs-table {
        border-collapse: collapse;
        border: 10px solid #3b0687;
        width: 100%;
        /* Ensure the table uses all available space */
    }

    #leaderboard-container .gridjs-tr .gridjs-td:nth-child(3) {
        font-weight: bold;
    }

    /* --- REMOVED CSS COUNTER FOR AUTO-RANKING --- */

    #leaderboard-container .gridjs-th:nth-child(17),
    #leaderboard-container .gridjs-td:nth-child(17) {
        display: none !important;
    }

    /* --- COLUMN WIDTH FIXES --- */

    /* Column 1 is now the first CSV column (e.g., 'Rank' or 'Name') */
    #leaderboard-container .gridjs-th:first-child,
    #leaderboard-container .gridjs-td:first-child {
        text-align: center;
    }

    /* Apply wrapping to the long headers (Original CSV columns are now 3, 4, 5) */
    #leaderboard-container .gridjs-th:nth-child(3) .gridjs-th-content,
    #leaderboard-container .gridjs-th:nth-child(4) .gridjs-th-content,
    #leaderboard-container .gridjs-th:nth-child(5) .gridjs-th-content {
        white-space: normal;
        word-break: break-word;
        line-height: 1.1;
        text-align: center;
    }

    /* General Cell Styling */
    #leaderboard-container .gridjs-th,
    #leaderboard-container .gridjs-td {
        border: 2px solid #3b0687;
        padding: 3px;
        text-align: center;
    }

    /* Name column (Original CSV column 2, now grid column 2 if first CSV column is 1) aligns left */
    #leaderboard-container .gridjs-td:nth-child(2) {
        text-align: left;
    }

    #leaderboard-container .gridjs-th:nth-child(2) .gridjs-th-content {
        text-align: left;
    }

    /* Header Styling */
    #leaderboard-container .gridjs-th {
        background-color: #ff0054;
        color: #ffffff;
        vertical-align: middle;
    }

    /* Stripe rows */
    #leaderboard-container .gridjs-tr:nth-child(even) .gridjs-td {
        background-color: #ddcdf5;
    }

    /* --- Filter CSS Restored --- */
    .search-and-filters-wrapper {
        display: flex;
        /* Enable flexbox for horizontal alignment */
        align-items: center;
        /* Vertically align items in the center */
        justify-content: flex-start;
        /* Move things to the start */
        margin-bottom: 15px;
        flex-wrap: wrap;
        /* Allow wrapping on smaller screens */
        gap: 10px;
        /* Space between search and filters */
    }

    /* Target the Grid.js Search box container */
    .gridjs-search {
        /* Set a max width so it doesn't consume all available space */
        max-width: 300px;
        flex-grow: 1;
        /* Allow it to grow, but respecting max-width */
    }

    /* Filter Container Styling (Adjusted for side-by-side) */
    .filter-controls {
        display: flex;
        /* Arranges filters side-by-side */
        gap: 15px;
        /* Reduced gap between filter dropdowns */
        margin-bottom: 0;
        /* No need for bottom margin here */
        flex-shrink: 0;
        /* Prevent filters from shrinking too much */
        flex-wrap: wrap;
        /* Allows wrapping on small screens */
    }

    /* Style for the Grid.js Search Input Box */
    .gridjs-search input[type='text'] {
        background-color: #663fa8 !important;
        /* Interior color */
        border: 2px solid #3b0687 !important;
        /* Exterior/Border color */
        color: white !important;
        /* Text color */
    }

    /* Style for the Custom Filter Dropdown Boxes (<select>) */
    .filter-controls select {
        background-color: #663fa8;
        /* Interior color */
        border: 2px solid #3b0687;
        /* Exterior/Border color */
        color: white;
        /* Text color */
        padding: 5px;
        border-radius: 3px;
    }

    /* Style for the Filter Labels (Text next to the dropdowns) */
    .filter-controls label {
        color: #3b0687;
        /* Use the dark purple for better visibility next to the colored boxes */
        font-weight: bold;
    }

    /* Media Queries (Updated Font Size) */
    @media (max-width: 1200px) {
        #leaderboard-container {
            font-size: 0.65rem;
            width: auto;
        }

        #leaderboard-container .gridjs-th,
        #leaderboard-container .gridjs-td {
            line-height: 1.1;
            padding: 2px !important;
        }
    }

    @media (max-width: 768px) {
        #leaderboard-container {
            font-size: 0.6rem;
        }


        #leaderboard-container .gridjs-th:nth-child(14),
        #leaderboard-container .gridjs-td:nth-child(14),
        #leaderboard-container .gridjs-th:nth-child(15),
        #leaderboard-container .gridjs-td:nth-child(15),
        #leaderboard-container .gridjs-th:nth-child(16),
        #leaderboard-container .gridjs-td:nth-child(16),
        #leaderboard-container .gridjs-th:nth-child(10),
        #leaderboard-container .gridjs-td:nth-child(10),
        #leaderboard-container .gridjs-th:nth-child(11),
        #leaderboard-container .gridjs-td:nth-child(11),
        #leaderboard-container .gridjs-th:nth-child(12),
        #leaderboard-container .gridjs-td:nth-child(12),
        #leaderboard-container .gridjs-th:nth-child(13),
        #leaderboard-container .gridjs-td:nth-child(13),
        #leaderboard-container .gridjs-th:nth-child(7),
        #leaderboard-container .gridjs-td:nth-child(7),
        #leaderboard-container .gridjs-th:nth-child(5),
        #leaderboard-container .gridjs-td:nth-child(5),
        #leaderboard-container .gridjs-th:nth-child(6),
        #leaderboard-container .gridjs-td:nth-child(6),
        #leaderboard-container .gridjs-th:nth-child(8),
        #leaderboard-container .gridjs-td:nth-child(8),
        #leaderboard-container .gridjs-th:nth-child(9),
        #leaderboard-container .gridjs-td:nth-child(9) {
            display: none !important;
        }
    }
</style>
<div id="leaderboard-banner">
        <img src="https://github.com/somaek/somaek.github.io/blob/main/INDI%20500%20PLATINUM.png?raw=true" alt="Leaderboard Banner" />
</div>

<div class="search-and-filters-wrapper">
        <div id="gridjs-search-placeholder"></div>
        <div class="filter-controls">
                <div style="margin-bottom: 0;">
                        <label for="gender-filter">   </label>
                        <select id="gender-filter">
                                <option value="">Bots and Humans</option>
                            </select>
                    </div>
            </div>
</div>

<div id="leaderboard-container">Loading leaderboard...</div>

<link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
<script>
    let gridInstance;

    // --- Grid.js Column Index Reference (The data now matches CSV indexing) ---
    // CSV Header Index | Data Array Index | Grid Column Index (0-based)
    // 0 (e.g. Rank)      | 0                  | 0
    // 1 (Name)           | 1                  | 1
    // ...
    // -------------------------------------------------------------------

    const csvURL = 'https://raw.githubusercontent.com/somaek/somaek.github.io/refs/heads/main/INDI500P.csv';

    const container = document.getElementById('leaderboard-container');
    // Gender filter select element
    const genderFilterSelect = document.getElementById('gender-filter');

    // Utility function to safely parse CSV rows (handling quotes)
    function parseCSVRow(row) {
        const result = [];
        let current = '';
        let inQuote = false;
        for (let i = 0; i < row.length; i++) {
            const char = row[i];
            if (char === '"') {
                inQuote = !inQuote;
            } else if (char === ',' && !inQuote) {
                // Push the current cell content, trimming whitespace and quotes
                result.push(current.trim().replace(/^"|"$/g, ''));
                current = '';
            } else {
                current += char;
            }
        }
        // Push the last cell
        result.push(current.trim().replace(/^"|"$/g, ''));
        return result;
    }

    // This function will apply the filtering based on the dropdown
    function applyGenderFilter(allData, genderDataIndex) {
        if (!gridInstance) return;

        const selectedGender = genderFilterSelect.value;

        let filteredData = allData.filter(row => {
            // MUST match the filter
            const genderMatch = selectedGender === "" || String(row[genderDataIndex]) === selectedGender;
            return genderMatch;
        });

        // Update the grid with the new filtered data
        gridInstance.updateConfig({
            data: filteredData
        }).forceRender();
    }


    fetch(csvURL)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(csvData => {
            const rows = csvData.trim().split(/\r\n|\r|\n/);
            const headers = parseCSVRow(rows[0]);

            // Define column names to find
            const genderColumnName = 'Gender';
            const defaultSortColumnName = 'Total';

            // Find column indices
            const genderColumnIndex = headers.indexOf(genderColumnName); // CSV header index
            const defaultSortColumnIndex = headers.indexOf(defaultSortColumnName); // CSV header index

            // Error check
            if (defaultSortColumnIndex === -1 || genderColumnIndex === -1) {
                throw new Error('Required CSV headers (Toal, Gender) not found.');
            }

            // Data array index is now the same as the CSV header index
            const genderDataIndex = genderColumnIndex;

            const expectedColumnCount = headers.length;

            const data = rows.slice(1).map(row => {
                    const cells = parseCSVRow(row);
                    if (cells.length !== expectedColumnCount) {
                        return null;
                    }
                    const dataRow = []; // NO longer prepending null for the CSS counter column ('#')
                    cells.forEach(cell => {
                        if (cell === "") {
                            dataRow.push(null);
                        } else {
                            const num = Number(cell);
                            dataRow.push(isNaN(num) ? cell : num);
                        }
                    });
                    return dataRow;
                })
                .filter(row => row !== null);

            const allData = data;

            // --- GENDER FILTER POPULATION ---
            if (genderColumnIndex >= 0) {
                // Data array index is now the same as CSV index
                const allGenderValues = allData.map(row => String(row[genderDataIndex]));
                // Get unique, sorted values
                const uniqueGenderValues = [...new Set(allGenderValues)].sort();

                uniqueGenderValues.forEach(gender => {
                    const option = document.createElement('option');
                    option.value = gender;
                    option.text = gender;
                    genderFilterSelect.appendChild(option);
                });

                // Add the event listener
                genderFilterSelect.addEventListener('change', () => applyGenderFilter(allData, genderDataIndex));
            }

            container.innerHTML = '';

            const columnObjects = headers.map(header => {
                return {
                    name: header
                };
            });

            // REMOVED: Prepend the '#' column object

            gridInstance = new gridjs.Grid({
                columns: columnObjects,
                data: allData, // Grid is initialized with ALL data
                search: true,
                autoWidth: true,
                sort: {
                    enabled: true,
                    // Grid.js column index (0-based) for initial sort is now the same as CSV index
                    index: defaultSortColumnIndex >= 0 ? defaultSortColumnIndex : 1,
                    direction: -1 // Descending
                },
                pagination: {
                    limit: 300
                },
            }).render(container);

            // --- FIX: RELOCATE SEARCH BAR AFTER IT'S FUNCTIONAL ---
            gridInstance.on('ready', () => {
                const gridSearchPlaceholder = document.getElementById('gridjs-search-placeholder');
                const gridSearchElement = container.querySelector('.gridjs-search');

                if (gridSearchElement && gridSearchPlaceholder) {
                    // 1. Move the search element
                    gridSearchPlaceholder.appendChild(gridSearchElement);
                }
            });
            // -----------------------------------------------------

        })
        .catch(error => {
            console.error('Error fetching or parsing data:', error);
            container.innerHTML = 'Error loading leaderboard. Wait a moment and then try refreshing.';
        });
</script>
